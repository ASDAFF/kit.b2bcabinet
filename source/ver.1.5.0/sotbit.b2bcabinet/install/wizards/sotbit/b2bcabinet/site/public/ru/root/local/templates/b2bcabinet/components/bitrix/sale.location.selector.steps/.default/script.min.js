BX.namespace("BX.Sale.component.location.selector"),void 0===BX.Sale.component.location.selector.steps&&void 0!==BX.ui&&void 0!==BX.ui.widget&&(BX.Sale.component.location.selector.steps=function(e,t){this.parentConstruct(BX.Sale.component.location.selector.steps,e),BX.merge(this,{opts:{bindEvents:{"after-select-item":function(e){"string"==typeof this.opts.callback&&this.opts.callback.length>0&&this.opts.callback in window&&window[this.opts.callback].apply(this,[e,this])}},disableKeyboardInput:!1,dontShowNextChoice:!1,pseudoValues:[],provideLinkBy:"id",requestParamsInject:!1},vars:{cache:{nodesByCode:{}}},sys:{code:"slst"},flags:{skipAfterSelectItemEventOnce:!1}}),this.handleInitStack(t,BX.Sale.component.location.selector.steps,e)},BX.extend(BX.Sale.component.location.selector.steps,BX.ui.chainedSelectors),BX.merge(BX.Sale.component.location.selector.steps.prototype,{init:function(){this.pushFuncStack("buildUpDOM",BX.Sale.component.location.selector.steps),this.pushFuncStack("bindEvents",BX.Sale.component.location.selector.steps)},buildUpDOM:function(){},bindEvents:function(){var e=this;this.opts.disableKeyboardInput&&this.bindEvent("after-control-placed",function(e){var t=e.getControl();BX.unbindAll(t.ctrls.toggle),BX.bind(t.ctrls.scope,"click",function(e){t.toggleDropDown()})}),BX.bindDelegate(this.getControl("quick-locations",!0),"click",{tag:"a"},function(){e.setValueByLocationId(BX.data(this,"id"))})},setValueByLocationId:function(e){BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[e])},setValueByLocationIds:function(e){e.PARENT_ID&&(this.flags.skipAfterSelectItemEventOnce=!0,this.setValueByLocationId(e.PARENT_ID),this.bindEvent("after-control-placed",function(t){var s=t.getControl();0==s.vars.value&&(e.IDS&&(this.opts.requestParamsInject={filter:{"=ID":e.IDS}}),s.tryDisplayPage("toggle"))}))},setValueByLocationCode:function(e){var t=this.vars;if(null==e||0==e||void 0===e||0==e.toString().length)return this.displayRoute([]),this.setValueVariable(""),this.setTargetValue(""),void this.fireEvent("after-clear-selection");this.fireEvent("before-set-value",[e]);var s=new BX.deferred,o=this;s.done(BX.proxy(function(s){this.displayRoute(s);var o=t.cache.nodesByCode[e].VALUE;t.value=o,this.setTargetValue(this.checkCanSelectItem(o)?o:this.getLastValidValue())},this)),s.fail(function(e){"notfound"==e&&(o.displayRoute([]),o.setValueVariable(""),o.setTargetValue(""),o.showError({errors:[o.opts.messages.nothingFound],type:"server-logic",options:{}}))}),this.hideError(),this.getRouteToNodeByCode(e,s)},setValue:function(e){"id"==this.opts.provideLinkBy?BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[e]):this.setValueByLocationCode(e)},setTargetValue:function(e){this.setTargetInputValue("code"==this.opts.provideLinkBy?e?this.vars.cache.nodes[e].CODE:"":e),this.flags.skipAfterSelectItemEventOnce?this.flags.skipAfterSelectItemEventOnce=!1:this.fireEvent("after-select-item",[e])},getValue:function(){return"id"==this.opts.provideLinkBy?!1===this.vars.value?"":this.vars.value:this.vars.value?this.vars.cache.nodes[this.vars.value].CODE:""},getNodeByLocationId:function(e){return this.vars.cache.nodes[e]},getSelectedPath:function(){var e=this.vars,t=[];if(void 0===e.value||0==e.value||""==e.value)return t;if(void 0!==e.cache.nodes[e.value])for(var s=e.cache.nodes[e.value];void 0!==s;){var o=BX.clone(s),i=o.PARENT_VALUE;if(delete o.PATH,delete o.PARENT_VALUE,delete o.IS_PARENT,void 0!==o.TYPE_ID&&void 0!==this.opts.types&&(o.TYPE=this.opts.types[o.TYPE_ID].CODE),t.push(o),void 0===i||void 0===e.cache.nodes[i])break;s=e.cache.nodes[i]}return t},setInitialValue:function(){!1!==this.opts.selectedItem?this.setValueByLocationId(this.opts.selectedItem):this.ctrls.inputs.origin.value.length>0&&("id"==this.opts.provideLinkBy?this.setValueByLocationId(this.ctrls.inputs.origin.value):this.setValueByLocationCode(this.ctrls.inputs.origin.value))},getRouteToNodeByCode:function(e,t){var s=this.vars,o=this;if(void 0!==e&&!1!==e&&e.toString().length>0){var i=[];void 0!==s.cache.nodesByCode[e]&&(i=this.getRouteToNodeFromCache(s.cache.nodesByCode[e].VALUE)),0==i.length?o.downloadBundle({request:{CODE:e},callbacks:{onLoad:function(a){for(var n in a)void 0===s.cache.links[n]&&(s.cache.incomplete[n]=!0);o.fillCache(a,!0),i=[],void 0!==s.cache.nodesByCode[e]&&(i=this.getRouteToNodeFromCache(s.cache.nodesByCode[e].VALUE)),0==i.length?t.reject("notfound"):t.resolve(i)},onError:function(){t.reject("internal")}},options:{}}):t.resolve(i)}else t.resolve([])},addItem2Cache:function(e){this.vars.cache.nodes[e.VALUE]=e,this.vars.cache.nodesByCode[e.CODE]=e},controlChangeActions:function(e,t){var s=this,o=this.opts,i=this.vars;this.ctrls;if(this.hideError(),0==t.length)s.truncateStack(e),i.value=s.getLastValidValue(),s.setTargetValue(i.value),this.fireEvent("after-select-real-value");else if(BX.util.in_array(t,o.pseudoValues))s.truncateStack(e),s.setTargetValue(s.getLastValidValue()),this.fireEvent("after-select-item",[t]),this.fireEvent("after-select-pseudo-value");else{var a=i.cache.nodes[t];if(void 0===a)throw new Error("Selected node not found in the cache");s.truncateStack(e),o.dontShowNextChoice?a.IS_UNCHOOSABLE&&s.appendControl(t):(void 0!==i.cache.links[t]||a.IS_PARENT)&&s.appendControl(t),s.checkCanSelectItem(t)&&(i.value=t,s.setTargetValue(t),this.fireEvent("after-select-real-value"))}},refineRequest:function(e){var t={},s={VALUE:"ID",DISPLAY:"NAME.NAME",1:"TYPE_ID",2:"CODE"},o={};void 0!==e.PARENT_VALUE&&(t["=PARENT_ID"]=e.PARENT_VALUE,s[10]="IS_PARENT"),void 0!==e.VALUE&&(t["=ID"]=e.VALUE,o[1]="PATH"),BX.type.isNotEmptyString(e.CODE)&&(t["=CODE"]=e.CODE,o[1]="PATH"),BX.type.isNotEmptyString(this.opts.query.BEHAVIOUR.LANGUAGE_ID)&&(t["=NAME.LANGUAGE_ID"]=this.opts.query.BEHAVIOUR.LANGUAGE_ID),BX.type.isNotEmptyString(this.opts.query.FILTER.SITE_ID)&&(void 0===this.vars.cache.nodes[e.PARENT_VALUE]||this.vars.cache.nodes[e.PARENT_VALUE].IS_UNCHOOSABLE)&&(t["=SITE_ID"]=this.opts.query.FILTER.SITE_ID);var i={select:s,filter:t,additionals:o,version:"2"};if(this.opts.requestParamsInject)for(var a in this.opts.requestParamsInject)if(this.opts.requestParamsInject.hasOwnProperty(a))for(var n in null==i[a]&&(i[a]={}),this.opts.requestParamsInject[a])if(this.opts.requestParamsInject[a].hasOwnProperty(n)){if(null!=i[a][n]){var r=i[a][n];i[a][n]=[],i[a][n].push(r)}else i[a][n]=[];for(var c in this.opts.requestParamsInject[a][n])this.opts.requestParamsInject[a][n].hasOwnProperty(c)&&i[a][n].push(this.opts.requestParamsInject[a][n][c])}return i},refineResponce:function(e,t){if(0==e.length)return e;if(void 0!==t.PARENT_VALUE){var s={};s[t.PARENT_VALUE]=e.ITEMS,e=s}else if(void 0!==t.VALUE||void 0!==t.CODE){var o={};if(void 0!==e.ITEMS[0]&&void 0!==e.ETC.PATH_ITEMS){for(var i=0,a=e.ITEMS[0].PATH.length-1;a>=0;a--){var n=e.ITEMS[0].PATH[a],r=e.ETC.PATH_ITEMS[n];r.IS_PARENT=!0,o[i]=[r],i=r.VALUE}o[i]=[e.ITEMS[0]]}e=o}return e},showError:function(e){"server-logic"!=e.type&&(e.errors=[this.opts.messages.error]),this.ctrls.errorMessage.innerHTML='<p><font class="errortext">'+BX.util.htmlspecialchars(e.errors.join(", "))+"</font></p>",BX.show(this.ctrls.errorMessage),BX.debug(e)}}));