window,window.BlogBFileDialog||(window.BlogBFileDialogUniqueID=[],window.BlogBFileDialog=function(e){this.dialogName="AttachmentsDialog",this.agent=!1,this.uploadFileUrl=e.upload_path,this.id=e.id?e.id:this.getID(),this.controlID=e.id,this.enabled=!0,this.controller=e.controller?e.controller:null,this.fileInput=e.fileInput,e.hAttachEvents=BX.delegate(this.InitAgent,this),this.msg=e.msg,this.dropAutoUpload=e.dropAutoUpload,this.CID=e.CID,this.multiple=!!e.multiple,e.caller=this,e.classes={uploaderParent:"file-uploader",uploader:"file-fileUploader",tpl_simple:"file-simple",tpl_extended:"file-extended",selector:"file-selector",selector_active:"file-selector-active"},e.doc_prefix="wd-doc",e.placeholder=BX.findChild(this.controller,{className:"file-placeholder-tbody"},!0),this.doc_prefix=e.doc_prefix,this.values=e.values||[],BX.FileUploadAgent?(this.agent=new BX.FileUploadAgent(e),BX.addCustomEvent(this,"ShowUploadedFile",BX.delegate(this.ShowUploadedFile,this)),BX.addCustomEvent(this,"StopUpload",BX.delegate(this.StopUpload,this)),BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormControllerInit",[this])):BX.debug("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/script.js: BX.FileUploadAgent is not defined. You need to load /bitrix/js/main/file_upload_agent.js")},window.BlogBFileDialog.prototype.getID=function(){return""+(new Date).getTime()},window.BlogBFileDialog.prototype.InitAgent=function(e){this.controller&&(e.placeholder=BX.findChild(this.controller,{className:"file-placeholder-tbody"},!0))},window.BlogBFileDialog.prototype.ShowUploadedFile=function(e){this.agent=e;var i=e.uploadResult;if(i&&i.element_id>0){if(e.inputName&&e.inputName.length>0){var t=BX.create("INPUT",{props:{id:"file-doc"+i.element_id,type:"hidden",name:e.inputName+(this.multiple?"[]":""),value:i.element_id}});e.controller.appendChild(t)}this.values.push(this.CreateFileRow(i)),e._clearPlace(),this.controller&&this.controller.parentNode&&BX.onCustomEvent(this.controller.parentNode,"OnFileUploadSuccess",[i,this])}else{var o=i&&i.error?i.error:this.msg.upload_error;e.ShowUploadError(o),this.controller&&this.controller.parentNode&&BX.onCustomEvent(this.controller.parentNode,"OnFileUploadFail")}},window.BlogBFileDialog.prototype.CreateFileRow=function(e){var t=e,o="file";t.element_content_type&&0==t.element_content_type.indexOf("image/")&&t.element_image&&t.element_image.length>0&&t.element_thumbnail&&t.element_thumbnail.length>0&&(o="image");var l=BX("file-"+o+"-template");BX.template(l,BX.delegate(function(e){this.tplFileRow(e,t)},this));var n=BX.clone(l);if("image"==o){var a=null;for(i=0;i<n.children.length&&1!=(a=n.children[i]).nodeType;i++);a.setAttribute("id",this.doc_prefix+e.element_id);var s=BX.findChild(a,{className:"feed-add-post-del-but"},!0);BX.bind(s,"click",BX.delegate(function(){var e=s.parentNode;this.agent.StopUpload(e),BX.cleanNode(e,!0)},this)),this.agent.AddNodeToPlaceholder(a),n=a}else n.setAttribute("id",this.doc_prefix+e.element_id),this.agent.AddRowToPlaceholder(n);return n},window.BlogBFileDialog.prototype.GetUploadDialog=function(e){return new BlogBFileDialogUploader(this,e)},window.BlogBFileDialog.prototype.tplFileRow=function(e,i){for(id in e)if(e.hasOwnProperty(id)){var t=e[id];"image"==id&&i.element_image&&i.element_image.length>0&&i.element_thumbnail&&i.element_thumbnail.length>0?(t.setAttribute("src",i.element_image),t.setAttribute("rel",i.element_thumbnail)):i["element_"+id]&&(t.innerHTML=i["element_"+id])}},window.BlogBFileDialog.prototype._addUrlParam=function(e,i){return e?(-1==e.indexOf(i)&&(e+=(-1==e.indexOf("?")?"?":"&")+i),e):null},window.BlogBFileDialog.prototype.LoadDialogs=function(e){if(this.agent)this.agent.LoadDialogs(e);else{var i=e;setTimeout(BX.delegate(function(){this.LoadDialogs(i)},this),100)}},window.BlogBFileDialog.prototype.StopUpload=function(e,i){this.agent=e,id=!1,mID=i.id.match(new RegExp(this.doc_prefix+"(\\d+)")),mID&&(id=mID[1]),this.controller&&this.controller.parentNode&&BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[id,this]);var t={fileID:id,sessid:BX.bitrix_sessid(),cid:this.CID,controlID:this.controlID,mfi_mode:"delete"};BX.ajax.post(this.uploadFileUrl,t)},window.BlogBFileDialogDispatcher=function(e){this.id=this.getID(),this.controller=e,BX.loadScript("/bitrix/js/main/core/core_dd.js",BX.delegate(function(){if(BX.type.isElementNode(this.controller)&&this.controller.parentNode&&this.controller.parentNode.parentNode){var e=this.controller.parentNode.parentNode;this.dropbox=new BX.DD.dropFiles(e),this.dropbox&&this.dropbox.supported()&&BX.ajax.FormData.isSupported()&&(this.hExpandUploader=BX.proxy(this.ExpandUploader,this),BX.addCustomEvent(this.dropbox,"dragEnter",this.hExpandUploader),BX.addCustomEvent(e,"UnbindDndDispatcher",BX.delegate(this.Unbind,this)))}},this))},window.BlogBFileDialogDispatcher.prototype.getID=function(){return""+(new Date).getTime()},window.BlogBFileDialogDispatcher.prototype.ExpandUploader=function(){BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormController",["show"])},window.BlogBFileDialogDispatcher.prototype.Unbind=function(){BX.removeCustomEvent(this.dropbox,"dragEnter",this.hExpandUploader)},window.BlogBFileDialogUploader=function(e,i){this.WDUploaded=!1,this.WDUploadInProgress=!1,this.documentExists=!1,this.fileDropped=!1,this.caller=e,this.agent=i,this.parentID=this.agent.id,this.id=this.caller.getID(),this.msg=e.msg,this.dropAutoUpload=e.dropAutoUpload,this.uploadFileUrl=e.uploadFileUrl,this.CID=e.CID,this.controlID=e.controlID,this.CreateElements(),this.fileInput=i.fileInput?i.fileInput:BX.type.isDomNode(i.fileInputID)?i.fileInputID:BX(e.fileInput),BX.type.isDomNode(this.fileInput)&&(this.fileInput.name="mfi_files[]"),this.fileList=this.__form,BX.loadScript("/bitrix/js/main/core/core_dd.js",BX.delegate(function(){var e=new BX.DD.dropFiles;e&&e.supported()&&BX.ajax.FormData.isSupported()&&(this.dropbox=e),this.agent.BindUploadEvents(this)},this))},window.BlogBFileDialogUploader.prototype.CreateElements=function(){var e;do{e=Math.floor(99999*Math.random())}while(BX("iframe-"+e));var i="iframe-"+this.id,t=BX.create("IFRAME",{props:{name:i,id:i},style:{display:"none"}});document.body.appendChild(t),this.iframeUpload=t;var o=BX.create("FORM",{props:{id:"form-"+e,method:"POST",action:this.uploadFileUrl,enctype:"multipart/form-data",encoding:"multipart/form-data",target:i},style:{display:"none"},children:[BX.create("INPUT",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("INPUT",{props:{type:"hidden",name:"uniqueID",value:e}}),BX.create("INPUT",{props:{type:"hidden",name:"cid",value:this.CID}}),BX.create("INPUT",{props:{type:"hidden",name:"controlID",value:this.controlID?this.controlID:""}}),BX.create("INPUT",{props:{type:"hidden",name:"mfi_mode",value:"upload"}})]});document.body.appendChild(o),this.__form=o,window["FILE_UPLOADER_CALLBACK_"+e]=BX.proxy(this.Callback,this)},window.BlogBFileDialogUploader.prototype.GetUploadFileName=function(){var e="";if(this.fileInput&&this.fileInput.value.length>0)(e=this.fileInput.value).indexOf("\\")>-1&&(e=e.substr(e.lastIndexOf("\\")+1));else{var i=this.fileList;i.file&&(e=i.file.fileName||i.file.name)}return e},window.BlogBFileDialogUploader.prototype.Callback=function(e,i){if(e.length>0)for(var t=0;t<e.length;t++){var o;(o={success:!0,storage:"bfile"}).element_id=e[t].fileID,o.element_name=e[t].originalName,o.element_size=e[t].fileSize,o.element_url=e[t].fileURL,o.element_content_type=e[t].content_type?e[t].content_type:e[t].fileContentType,o.element_image=e[t].img_thumb_src?e[t].img_thumb_src:e[t].fileSrc,o.element_image&&(o.element_image=o.element_image.replace(/\/([^\/]+)$/,function(e,i){return"/"+BX.util.urlencode(i)})),o.element_thumbnail=e[t].img_source_src?e[t].img_source_src:e[t].fileSrc,o.element_thumbnail&&(o.element_thumbnail=o.element_thumbnail.replace(/\/([^\/]+)$/,function(e,i){return"/"+BX.util.urlencode(i)})),e[t].error&&(o.error=e[t].error),BX.onCustomEvent(this,"uploadFinish",[o])}else(o={success:!1}).messages=this.msg.upload_error,BX.onCustomEvent(this,"uploadFinish",[o]);window["FILE_UPLOADER_CALLBACK_"+i]=BX.DoNothing,BX.cleanNode(BX("iframe-"+i),!0),BX.cleanNode(BX("form-"+i),!0),this.agent.uploadDialog=null},window.BlogBFileDialogUploader.prototype.UploadResponse=function(e,i){this.WDUploadInProgress=!1,BX.unbind(window,"beforeunload",BX.proxy(this.UploadLeave,this)),(!i||i.length<=0)&&this.onError()},window.BlogBFileDialogUploader.prototype.UploadResponseIframe=function(e,i){this.WDUploadInProgress=!1,BX.unbind(window,"beforeunload",BX.proxy(this.UploadLeave,this))},window.BlogBFileDialogUploader.prototype.UploadLeave=function(e){e=e||window.event;var i="";if(this.WDUploadInProgress?i=this.msg.UploadInterrupt:!this.WDUploaded&&this.fileInput&&this.fileInput.value.length>0&&(i=this.msg.UploadNotDone),""!=i)return e&&(e.returnValue=i),i},window.BlogBFileDialogUploader.prototype.UpdateListFiles=function(e){if(this&&e){if(e.length<1)return;this.fileList.file=e[0],this.WDUploadInProgress=!0,this.fileDropped=!0,this.CallSubmit()}},window.BlogBFileDialogUploader.prototype.GetInputData=function(e){var i=[],t={};i=i.concat(BX.findChildren(e,{tag:"input"},!0),BX.findChildren(e,{tag:"textarea"},!0),BX.findChildren(e,{tag:"select"},!0));for(var o=0;o<i.length;o++){var l=i[o];if(!(!l||l.disabled||l.name.length<1))switch(l.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":t[l.name]=l.value;break;case"radio":l.checked&&(t[l.name]=l.value);break;case"checkbox":t[l.name]=l.checked?"Y":"N";break;case"select-multiple":var n=l.options.length;for(n>0&&(t[l.name]=new Array),j=0;j<n;j++)l.options[j].selected&&t[l.name].push(l.options[j].value)}}return t},window.BlogBFileDialogUploader.prototype.SetFileInput=function(e){this.__form.mfi_save||(this.fileInput&&this.fileInput!=e&&BX.remove(this.fileInput),this.__form.appendChild(e),this.fileInput=e)},window.BlogBFileDialogUploader.prototype.CallSubmit=function(){if(!this.__form.mfi_save)if(BX.onCustomEvent(this,"uploadStart",[this]),BX.bind(window,"beforeunload",BX.proxy(this.UploadLeave,this)),BX.bind(this.iframeUpload,"load",BX.delegate(this.UploadResponseIframe,this)),this.dropbox){this.onProgress(.15),this.fileInput&&this.fileInput.files.length>0&&(this.fileList.file=this.fileInput.files[0]);var e=this.GetInputData(this.__form);for(i in this.fileNodes=[this.fileList],this.fileNodes)if(this.fileNodes[i].file){var t=new BX.ajax.FormData;for(item in this.fileNodes[i].data)t.append(item,this.fileNodes[i].data[item]);if(Object&&Object.keys){var o=Object.keys(e);for(var l in o){var n=o[l],a=e[n];t.append(n,a)}}else for(item in e)t.append(item,e[item]);t.append("mfi_files[]",this.fileNodes[i].file),t.send(this.uploadFileUrl,BX.delegate(function(e){this.UploadResponse(null,e)},this),BX.delegate(this.onProgress,this))}}else this.onProgress(.15),this.WDUploadInProgress=!0,this.__form.id,BX.submit(this.__form,"mfi_save","Y")},window.BlogBFileDialogUploader.prototype.onProgress=function(e){isNaN(e)||BX.onCustomEvent(this,"progress",[e])},window.BlogBFileDialogUploader.prototype.onError=function(){BX.onCustomEvent(this,"uploadFinish",[{success:!1,messages:this.msg.upload_error}])},top.BlogBFileDialog=window.BlogBFileDialog,top.BlogBFileDialogUploader=window.BlogBFileDialogUploader,top.BlogBFileDialogDispatcher=window.BlogBFileDialogDispatcher,window.MFIDD=function(e){BX.loadCSS("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/style.css");var i="show"===e.status?"show":"hide"===e.status?"hide":"switch";"switch"==i&&(i="none"!=e.controller.style.display?"hide":"show");var t=function(i){"show"==i&&(BX.fx.show(e.controller,"fade",{time:.2}),e.switcher&&"none"!=e.switcher.style.display&&BX.fx.hide(e.switcher,"fade",{time:.1}),window["BfileUnbindDispatcher"+e.uid]&&window["BfileUnbindDispatcher"+e.uid]())};if(e.controller.loaded)t(i);else{e.controller.loaded=!0;var o=new BX.DD.dropFiles,l=o&&o.supported()&&BX.ajax.FormData.isSupported()?"extended":"simple";top["BfileFD"+e.uid]=window["BfileFD"+e.uid]=new BlogBFileDialog({mode:l,CID:e.CID,id:e.id,upload_path:e.upload_path,multiple:e.multiple,controller:e.controller,inputName:e.inputName,fileInput:"file-fileUploader-"+e.uid,fileInputName:"mfi_files[]",values:BX.findChildren(BX("file-selectdialog-"+e.uid),{className:"file-inline-file"},!0),msg:{loading:BX.message("loading"),file_exists:BX.message("file_exists"),upload_error:BX.message("upload_error"),access_denied:BX.message("access_denied")}}),t(i),window["BfileFD"+e.uid].LoadDialogs("DropInterface"),BX.onCustomEvent("BFileDSelectFileDialogLoaded",[window["BfileFD"+e.uid]])}},window.BlogBFileJustDialog=function(e){this.dialogName="AttachmentsDialog",this.agent=!1,this.id=e.id?e.id:this.getID(),this.controlID=e.id,this.enabled=!0,this.uploadFileUrl=e.upload_path,this.controller=e.controller?e.controller:null,this.CID=e.CID,e.caller=this,e.doc_prefix="wd-doc",e._mkFileInput=BX.DoNothing,e.mode="extended",e.classes={tpl_simple:"file-simple",tpl_extended:"file-extended"},this.doc_prefix=e.doc_prefix,BX.FileUploadAgent?(this.agent=new BX.FileUploadAgent(e),BX.addCustomEvent(this,"StopUpload",BX.delegate(this.StopUpload,this)),BX.onCustomEvent(BX(this.controller.parentNode),"BFileDLoadFormControllerInit",[this])):BX.debug("/bitrix/components/bitrix/main.file.input/templates/drag_n_drop/script.js: BX.FileUploadAgent is not defined. You need to load /bitrix/js/main/file_upload_agent.js")},window.BlogBFileJustDialog.prototype.StopUpload=function(e,i){this.agent=e,id=!1,mID=i.id.match(new RegExp(this.doc_prefix+"(\\d+)")),mID&&(id=mID[1]),this.controller&&this.controller.parentNode&&BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[id,this]);var t={fileID:id,sessid:BX.bitrix_sessid(),cid:this.CID,controlID:this.controlID,mfi_mode:"delete"};BX.ajax.post(this.uploadFileUrl,t)},window.MFIS=function(e){e.controller.loaded||(e.controller.loaded=!0,top["BfileFD"+e.uid]=window["BfileFD"+e.uid]=new BlogBFileJustDialog({CID:e.CID,id:e.id,upload_path:e.upload_path,controller:e.controller,values:BX.findChildren(BX("file-selectdialog-"+e.uid),{className:"file-inline-file"},!0)}),BX.fx.show(e.controller,"fade",{time:.2}),BX.onCustomEvent("BFileDSelectFileDialogLoaded",[window["BfileFD"+e.uid]]))});